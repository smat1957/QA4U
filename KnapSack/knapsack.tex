% latex uft-8
\documentclass[uplatex,dvipdfmx,a4paper,11pt,oneside,openany]{jsbook}
%
\usepackage[dvipdfmx]{graphicx}
\usepackage{amsmath,amssymb}
\usepackage{bm}
\usepackage{physics}
\usepackage{graphicx}
\usepackage{ascmac}
\usepackage{amsmath}
\usepackage{setspace}
\usepackage{here}
\usepackage{fancybox}
\usepackage{url}
\usepackage{listings,jlisting} %日本語のコメントアウトをする場合jlistingが必要
\usepackage{xcolor}
\usepackage{comment}
\usepackage{multicol}
\usepackage{amsmath, amssymb}
\usepackage{type1cm}
\usepackage{fancybox}

\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mygray}{rgb}{0.5,0.5,0.5}
\definecolor{mymauve}{rgb}{0.58,0,0.82}

%\begin{comment}
\lstset{
  backgroundcolor=\color{white},   % choose the background color; you must add \usepackage{color} or \usepackage{xcolor}; should come as last argument
  basicstyle=\footnotesize,        % the size of the fonts that are used for the code
  breakatwhitespace=false,         % sets if automatic breaks should only happen at whitespace
  breaklines=true,                 % sets automatic line breaking
  captionpos=b,                    % sets the caption-position to bottom
  commentstyle=\color{mygreen},    % comment style
  deletekeywords={...},            % if you want to delete keywords from the given language
  escapeinside={\%*}{*)},          % if you want to add LaTeX within your code
  extendedchars=true,              % lets you use non-ASCII characters; for 8-bits encodings only, does not work with UTF-8
  firstnumber=1000,                % start line enumeration with line 1000
  frame=single,	                   % adds a frame around the code
  keepspaces=true,                 % keeps spaces in text, useful for keeping indentation of code (possibly needs columns=flexible)
  keywordstyle=\color{blue},       % keyword style
  language=Octave,                 % the language of the code
  morekeywords={*,...},            % if you want to add more keywords to the set
  numbers=left,                    % where to put the line-numbers; possible values are (none, left, right)
  numbersep=5pt,                   % how far the line-numbers are from the code
  numberstyle=\tiny\color{mygray}, % the style that is used for the line-numbers
  rulecolor=\color{black},         % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. comments (green here))
  showspaces=false,                % show spaces everywhere adding particular underscores; it overrides 'showstringspaces'
  showstringspaces=false,          % underline spaces within strings only
  showtabs=false,                  % show tabs within strings adding particular underscores
  stepnumber=2,                    % the step between two line-numbers. If it's 1, each line will be numbered
  stringstyle=\color{mymauve},     % string literal style
  tabsize=2,	                   % sets default tabsize to 2 spaces
  title=\lstname                   % show the filename of files included with \lstinputlisting; also try caption instead of title
}
%\end{comment}

\lstdefinelanguage{mypy}{
  % リテラルと演算記号
  morekeywords=[1]{+=,=,==,!=,!,>,<,>=,<=,++,-,+,*,\%,/},
  % 予約語
  morekeywords=[2]{False,None,True,and,as,assert,async,await,break,
    class,continue,def,del,elif,else,except,finally,for,from,global,
    if,import,in,is,lambda,nonlocal,not,or,pass,raise,return,try,while,
    with,yield,print,match,case
  },
  % 識別子
  morekeywords=[3]{defined_func},
  % 区切り文字を強制的に色付け
  literate=*{.}{{\color{delimiter}.}}1
            {,}{{\color{delimiter},}}1 {:}{{\color{delimiter}:}}1
            {)}{{\color{delimiter})}}1 {(}{{\color{delimiter}(}}1
            {[}{{\color{delimiter}[}}1 {]}{{\color{delimiter}]}}1
            {\{}{{\color{delimiter}\{}}1 {\}}{{\color{delimiter}\}}}1,
  % 大文字小文字を区別
  sensitive=true,
  % 行コメントの設定
  morecomment=[l]{\#},
  % Stringリテラルの設定
  morestring=[b]{\'},
  morestring=[b]{\"},
  % 単語として扱う文字
  alsoletter={\%<>=+-*\/1234567890!},
  % 枠
  frame=none,
  % 長くなったら途中で改行
  breaklines=true,
  % 自動改行時のインデント
  breakindent=12pt,
  % 文字間隔を一定に
  columns=fixed,
  % 文字の横のサイズを小さく
  basewidth=0.5em,
  % 行番号を左に
  numbers=left,
  % 行番号の書式
  numberstyle={\scriptsize\color{white}},
  % 行番号の増加数は1=連番に
  stepnumber=1,
  % フレームの左の余白
  framexleftmargin=18pt,
  % スペースを省略せず保持
  keepspaces=true,
  % インデントサイズ
  tabsize=4,
  backgroundcolor={},                                   % 背景色=透明
  basicstyle={\small\ttfamily\color{white}},            % 通常部分の書式
  identifierstyle={\small\color{white}},                % 識別子の書式
  commentstyle={\small\color{comment}},                 % コメントの書式
  keywordstyle=[1]{\small\bfseries\color{literal}},     % リテラルと演算記号の書式
  keywordstyle=[2]{\small\bfseries\color{reserved}},    % 予約語の書式
  keywordstyle=[3]{\small\bfseries\color{identifier}},  % 自分で定義した識別子の書式
  stringstyle={\small\ttfamily\color{literal}},         % 文字列の書式
}
%ここからソースコードの表示に関する設定
\lstdefinestyle{customc}{
  belowcaptionskip=1\baselineskip,
  breaklines=true,
  numbers=left,
  frame=single,
  xleftmargin=\parindent,
  language=C,
  showstringspaces=false,
  basicstyle=\footnotesize\ttfamily,
  keywordstyle=\bfseries\color{green!40!black},
  commentstyle=\itshape\color{purple!40!black},
  identifierstyle=\color{blue},
  stringstyle=\color{orange},
}

\lstdefinestyle{custompy}{
  belowcaptionskip=1\baselineskip,
  breaklines=true,
  numbers=none,
  frame=l,
  xleftmargin=\parindent,
  language=python,
  showstringspaces=false,
  basicstyle=\footnotesize\ttfamily,
  keywordstyle=\bfseries\color{green!40!black},
  commentstyle=\itshape\color{purple!40!black},
  identifierstyle=\color{blue},
  stringstyle=\color{orange},
}

\lstdefinestyle{customasm}{
  belowcaptionskip=1\baselineskip,
  frame=L,
  xleftmargin=\parindent,
  language=[x86masm]Assembler,
  basicstyle=\footnotesize\ttfamily,
  commentstyle=\itshape\color{purple!40!black},
}

\lstset{escapechar=@,style=custompy}
\renewcommand{\lstlistingname}{プログラム}

\begin{comment}
\makeatletter
\def\ps@plainfoot{%
  \let\@mkboth\@gobbletwo
  \let\@oddhead\@empty
  \def\@oddfoot{\normalfont\hfil-- \thepage\ --\hfil}%
  \let\@evenhead\@empty
  \let\@evenfoot\@oddfoot}
  \let\ps@plain\ps@plainfoot
  \renewcommand{\chapter}{%
  \if@openright\cleardoublepage\else\clearpage\fi
  \global\@topnum\z@
  \secdef\@chapter\@schapter}
\makeatother
\end{comment}

%
\newcommand{\maru}[1]{{\ooalign{%
\hfil\hbox{$\bigcirc$}\hfil\crcr%
\hfil\hbox{#1}\hfil}}}
%
\setlength{\textwidth}{\fullwidth}
\setlength{\textheight}{40\baselineskip}
\addtolength{\textheight}{\topskip}
\setlength{\voffset}{-0.55in}
%
\makeatletter
\newenvironment{tablehere}
  {\def\@captype{table}}
  {}
\newenvironment{figurehere}
  {\def\@captype{figure}}
  {}
\makeatother

%
\begin{document}
\chapter{ナップザック問題を量子アニーリングで解く}

参考にしたネット上の記事：

\url{https://qiita.com/farcpan/items/5c2053ce1fd79e644eef}

\url{https://zenn.dev/ayu_dev/articles/caca48408b7754}

\section{問題}

それぞれに価値$v$とコスト（例えば体積）$c$が設定されている$N$個の荷物がある。
あるナップザックに、それらから荷物を選んで詰めて運ぼうとしている。
運ぶ荷物の価値の総和ができるだけ大きくになる様に荷物を選びたいが、ナップザックには許容される容量に限度があり、その値は$C$である。この決められたコストを上回らない様に、選んだ荷物の価値合計を最大化する様な荷物の選び方を決める問題である。

$N$個の荷物にインデックス$\alpha=1,2,\cdots,N$をつける。
ナップザックに入れる荷物に対応する変数には1を、入れない荷物には0を割り当てる事にすると、この問題は以下の様に書ける。

\begin{eqnarray}
  max \hspace{5mm} \sum_{\alpha=1}^N v_{\alpha}q_{\alpha} \hspace{1cm} s.t. \hspace{5mm} \sum_{\alpha=1}^N c_{\alpha}q_{\alpha} \leq C
\end{eqnarray}

\section{定式化（その1）}

イジングモデルのハミルトニアン$H$は、選択した荷物の価値合計を最大化する項$H_{value}$と、コストを$C$以下になる様にする制約事項の項$H_{cost}$の2つからなっている。
\begin{eqnarray}
  H = H_{value} + H_{cost}
\end{eqnarray}

$H_{value}$は次の通り
\begin{eqnarray}
  H_{value}=-\sum_\alpha^Nv_\alpha q_\alpha\;,\hspace{10mm}q_\alpha\in\{0,1\}
\end{eqnarray}

価値の合計が最大の時に、$H_{value}$は最小値をとる。

一方、制約条件の項だが、選んだ荷物のコスト（各体積）の合計$\sum_\alpha c_\alpha q_\alpha$が、ナップザックの最大許容体積である$C$と等しいとする制約条件ならば、次の様になる
\begin{eqnarray}
  H_{cost} = \lambda\left(C-\sum_{\alpha=1}^N c_\alpha q_\alpha\right)^2
\end{eqnarray}
ここで、パラメータ$\lambda$は正の定数である。

この制約条件を展開する
\begin{eqnarray*}
  H_{cost} = \lambda\bigg(C - \sum_\alpha c_\alpha q_\alpha\bigg)^2
  &=&\lambda\bigg(C^2 - 2C\sum_\alpha c_\alpha q_\alpha + \bigg(\sum_\alpha c_\alpha q_\alpha\bigg)^2\bigg)\\
  &=&\lambda\bigg(-2C\sum_{\alpha=1}^Nc_\alpha q_\alpha + \sum_{\alpha=1}^Nc_\alpha^2 q_\alpha^2 + 2\sum_{\alpha_1<\alpha_2}c_{\alpha_1}c_{\alpha_2}q_{\alpha_1}q_{\alpha_2}\bigg)\\
  &=&\lambda\bigg(\sum_{\alpha=1}^Nc_\alpha(c_\alpha-2C)q_\alpha + 2\sum_{\alpha_1<\alpha_2}c_{\alpha_1}c_{\alpha_2}q_{\alpha_1}q_{\alpha_2}\bigg)\\
&=&\lambda\bigg(\sum_{\alpha=1}^Nc_\alpha(c_\alpha-2C)q_\alpha+2\sum_{\alpha=1}^{N-1}\sum_{\beta=\alpha+1}^Nc_\alpha c_\beta q_\alpha q_\beta\bigg)
\end{eqnarray*}

\begin{screen}
式の変形にあたっては、以下の性質を利用している.
\[
\left(\sum_i a_i x_i\right)^2=\sum_i a_i^2 x_i^2 + 2\sum_{i<j}a_i a_j x_i x_j
\]
また, バイナリ変数に対する $s_k^2=s_k,\;\; s_k \in \{0, 1\}$ の性質も使っている。
\end{screen}

こうして、この問題のハミルトニアン$H$は、$\lambda_1$と$\lambda_2$を正の定数として、次の様に書ける。
\begin{eqnarray*}
  H = H_{cost} + H_{value} = \lambda_1\bigg(\sum_{\alpha=1}^Nc_\alpha(c_\alpha-2C)q_\alpha+2\sum_{\alpha=1}^{N-1}\sum_{\beta=\alpha+1}^Nc_\alpha c_\beta q_\alpha q_\beta\bigg) - \lambda_2\sum_\alpha^Nv_\alpha q_\alpha
\end{eqnarray*}


\begin{screen}
制約条件の項にかかるパラメータ$\lambda$を決める必要がある.\\
これを適当に決めた場合には,得られる最適解は期待したものにはならない.

例えば,$1\gg\lambda$となるようなパラメータを選んだ場合には,価値合計を最大化する項が強くなり,制約条件の項が相対的に弱くなる.
これはすなわち,最適解として得たQUBO変数が,制約条件を満たさない可能性が高いことを意味する.
一方で,$1\ll\lambda$を満たすパラメータを選んだ場合,制約条件の項が強くなり制約条件が優先的に満たされるようになるが,一方で価値合計が最大とはならない可能性が高くなる.

最適解を与えるQUBO変数列$\{q_\alpha\}$
を用意し、適当に選んだQUBO変数$q_k \in \{q_\alpha\}$を1つだけ変更することを考える.
このとき価値合計は$|\Delta H_{value}|=c_k$だけ小さくなる.
制約条件の項が全体のハミルトニアンに影響するためには,以下を満たすようにパラメータを選ぶのがよい.

\[
0 \le max(c_\alpha)\le\lambda
\]
\end{screen}

\subsection{実装}

具体的な問題を解いてみる。
下表の通り、$A,B,C,D,E$の$N=5$個の荷物がある。それぞれの荷物の価値と体積は表の通りである。また、ナップザックの最大許容体積$C$は12である。\\

\begin{tabular}{|l|ccccc|}\hline
  荷物 & A & B & C & D & E \\\hline
  インデックス($\alpha$) & 1 & 2 & 3 & 4 & 5 \\\hline
  体積($c_\alpha$) & 3 & 4 & 6 & 1 & 5 \\\hline
  価値($v_\alpha$) & 6 & 7 & 8 & 1 & 4 \\\hline
\end{tabular}\\

プログラムのコードに落としてみると次の通り

\lstinputlisting[caption=MODEL1,label=l1]{knapsack.py}

プログラムの実行

\begin{verbatim}
  -63.7    24.0    36.0     6.0    30.0
    0.0   -80.8    48.0     8.0    40.0
    0.0     0.0  -108.9    12.0    60.0
    0.0     0.0     0.0   -23.1    10.0
    0.0     0.0     0.0     0.0   -95.4

Sorted samples by frequency and energy:
Sample: (1, 1, 0, 0, 1), Frequency: 37, Energy: -145.89
Sample: (0, 0, 1, 1, 1), Frequency: 30, Energy: -145.44
Sample: (1, 1, 1, 0, 0), Frequency: 30, Energy: -145.33
Sample: (0, 1, 1, 1, 0), Frequency: 2, Energy: -144.78
Sample: (0, 0, 1, 0, 1), Frequency: 1, Energy: -144.33

Evaluation of solutions:
[ 1] Frequency=37, Energy=-145.89,
 Solution=(1, 1, 0, 0, 1)	: value=17.0, cost=12.0
[ 2] Frequency=30, Energy=-145.44,
 Solution=(0, 0, 1, 1, 1)	: value=13.0, cost=12.0
[ 4] Frequency=2, Energy=-144.78,
 Solution=(0, 1, 1, 1, 0)	: value=16.0, cost=11.0
[ 5] Frequency=1, Energy=-144.33,
 Solution=(0, 0, 1, 0, 1)	: value=12.0, cost=11.0

プロセスは終了コード 0 で終了しました
\end{verbatim}

\section{定式化（その2）}

しかし今の問題では、総体積は必ずしも$C$に等しい必要はなく、$C$より小さい総体積であっても、価値合計が大きいのであれば、そちらの方を最適解だと選ぶ事になる。従ってここでは「コストの合計値が$C$以下」になるとする制約条件が必要になる。そこで新たに補助変数（slack返送鵜と呼ばれる）$s_k \in \{0, 1\}, k=1,2,\dots,C$を用意して、次の通り定式化する。
\begin{eqnarray}
  H_{cost} = \lambda \left[\left(1-\sum_k s_k\right)^2+\left(\sum_k ks_k - \sum_\alpha c_\alpha q_\alpha\right)^2\right] = \lambda\left(H_{cost}^{(1)} + H_{cost}^{(2)}\right)
\end{eqnarray}

まずは$H_{cost}^{(1)}$を展開する.

\begin{eqnarray*}
H_{cost}^{(1)}&=&\left(1-\sum_k s_k\right)^2\\
&=&1-2\sum_k s_k + \left(\sum_k s_k\right)^2\\
&=&1-2\sum_k s_k + \left(\sum_k s_k^2 + 2\sum_{k<l}s_k s_l\right)\\
&=&1-\sum_k s_k + 2\sum_{k<l}s_k s_l
\end{eqnarray*}

次に、$H_{cost}^{(2)}$を展開する.

\begin{eqnarray*}
  H_{cost} ^{(2)} &=& \left( \sum _{k} k s_{k} - \sum _{\alpha} c_{\alpha} q_{\alpha} \right) ^{2} \\
  &=& \left( \sum _{k} k s_{k} \right) ^{2} + \left( \sum _{\alpha} c_{\alpha} q_{\alpha} \right) ^{2} - 2 \sum _{k} \sum _{\alpha} kc_{\alpha} s_{k} q_{\alpha} \\
  &=& \left(\sum _{k} k^{2} s_{k} + 2\sum _{k < l} kls_{k}s_{l}\right) + \left(\sum _{\alpha} c_{\alpha} ^{2} q_{\alpha} + 2\sum _{\alpha < \beta} c_{\alpha} c_{\beta} q_{\alpha} q_{\beta}\right) - 2 \sum_{k} \sum _{\alpha} kc_{\alpha} s_{k} q_{\alpha}
\end{eqnarray*}

こうして、$H_{cost}=H_{cost}^{(1)}+H_{cost}^{(2)}$は、次の様になる。
\begin{eqnarray*}
  \frac{H_{cost}}{\lambda } = 1 + \sum _{k} (k^{2} - 1) s_{k} + 2\sum _{k < l} (kl + 1) s_{k}s_{l} + \sum _{\alpha} c_{\alpha} ^{2} q_{\alpha} + 2\sum _{\alpha < \beta} c_{\alpha} c_{\beta} q_{\alpha} q_{\beta} - 2 \sum_{k} \sum _{\alpha} kc_{\alpha} s_{k} q_{\alpha}
\end{eqnarray*}


ここで,$s_k$もQUBO変数の一種と見なす.すなわち,
\[
s_{k} \longrightarrow q_{\alpha}, \quad \alpha = k + N
\]

以上の様にすれば,ハミルトニアンは以下のようになる.

\begin{eqnarray*}
    \frac{H_{cost}}{\lambda} &=& 1 + \sum _{k=1} ^{C} (k^{2} - 1) q_{k + N} + \sum _{\alpha=1} ^{N} c_{\alpha} ^{2} q_{\alpha}\\
    & +& 2\sum _{k=1} ^{C-1} \sum _{l=k+1}^{C} (kl + 1) q_{k+N}q_{l+N} + 2\sum _{\alpha = 1} ^{N-1} \sum _{\beta = \alpha + 1} ^{N} c_{\alpha} c_{\beta} q_{\alpha} q_{\beta} - 2 \sum_{k=1} ^{C} \sum _{\alpha=1} ^{N} kc_{\alpha} q_{k+N} q_{\alpha}
\end{eqnarray*}

\subsection{実装}

$C$個のslack変数$s_1, \cdots, s_{C-1}, s_C$を導入して、その中の1つだけが1になることを許す（複数の1は禁止）を課している。\\

\begin{tabular}{|l|c|c|c|c|c|c|c|}\hline
  ナップザックの体積（$c$） & 1 & 2 & 3 & \dots & 10 & 11 & 12 \\\hline
  総体積($c$)になるかどうか（$s_n$） & 0 & 0 & 0 & \dots & 0 & 0 & 1 \\\hline
  $n\times s_n$ & 0 & 0 & 0 & \dots & 0 & 0 & 12 \\
  & $1\times 0$ & $2\times 0$ & $3\times 0$ & \dots & $10\times 0$ & $11\times 0$ & $12\times 1$ \\\hline
 \end{tabular}\\

一方、ナップサックの荷物の体積の総和(荷物の総体積)は以下で求められる。

\[
c = \sum_{\alpha=1}^{N}c_\alpha q_\alpha = c_1 q_1 + c_2 q_2 + c_3 q_3 + \dots + c_N q_N
\]

$q_n$は$0,1$を取る決定変数で, $n$番目の荷物をナップサックに詰めるかどうかを決める変数なので, 例えば下表のように荷物$C,D,E$を選択すれば, 荷物の総体積（$3\times 0+4\times 0+6\times 1+1\times 1+5\times 1=12$）を12にすることができる.\\

\lstinputlisting[caption=MODEL2,label=l2]{model2.py}

ここで作成したcost2()関数は、結局のところ「12以下」のいずれの場合も許容されることになり、そのいずれの場合でも等しく低いエネルギーレヴェルを実現できることになる。そこで、MODEL1クラスで作成したcos()関数を追加してみた。ただし、このcost()関数の寄与を大きくすると結局MODEL1と同じことをしている事になるので要注意。

以下の結果の出力では、選ばれた荷物の容積の総和が12を超えるものは表示していない

\begin{verbatim}
  -306.7   168.0   252.0    42.0   210.0
  0.0  -384.8   336.0    56.0   280.0
  0.0     0.0  -504.9    84.0   420.0
  0.0     0.0     0.0  -114.1    70.0
  0.0     0.0     0.0     0.0  -450.4

Sorted samples by frequency and energy:
Sample: (0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0), Frequency: 2, Energy: -653.67
Sample: (0, 1, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0), Frequency: 1, Energy: -643.33
Sample: (0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0), Frequency: 1, Energy: -656.33
Sample: (0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0), Frequency: 1, Energy: -655.33
Sample: (0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0), Frequency: 1, Energy: -635.44
Sample: (0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0), Frequency: 1, Energy: -525.11
Sample: (0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0), Frequency: 1, Energy: -652.67
Sample: (0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0), Frequency: 1, Energy: -656.33
Sample: (0, 1, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0), Frequency: 1, Energy: -642.33

Evaluation of solutions:
[ 1] Frequency=2, Energy=-653.67,
Solution=(0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0)	: value=15.0, cost=10.0
[ 2] Frequency=1, Energy=-643.33,
Solution=(0, 1, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0)	: value=12.0, cost=10.0
[ 3] Frequency=1, Energy=-656.33,
Solution=(0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)	: value=12.0, cost=11.0
[ 4] Frequency=1, Energy=-655.33,
Solution=(0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0)	: value=12.0, cost=11.0
[ 5] Frequency=1, Energy=-635.44,
Solution=(0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0)	: value=13.0, cost=12.0
[ 7] Frequency=1, Energy=-652.67,
Solution=(0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0)	: value=15.0, cost=10.0
[ 8] Frequency=1, Energy=-656.33,
Solution=(0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0)	: value=12.0, cost=11.0
[ 9] Frequency=1, Energy=-642.33,
Solution=(0, 1, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0)	: value=12.0, cost=10.0

プロセスは終了コード 0 で終了しました
\end{verbatim}

\section{定式化（その3）}

slack変数は、決定変数$q_\alpha$の後ろに繋げて解く事になるので、不等式の制約条件によっては、slack変数の数が多くなるという不都合がある。そこで、slack変数のバイナリエンコーディングを行うことがある。今のナップザックぬ問題の具体例では、ナップザックの最大容量$C$が12だとしているので、前の例の様なslack変数の使い方だと、$s_1, s_2,\cdots,s_{C-1}, s_C$と、全部で$C=12$個のslack変数を追加していることになる。一方バイナリーエンコーディングでは、例えば12なら、次の表の様な2進数の4桁で表現できるので、4個のslack変数を用意すれば良い事になる。\\
\[
12 = (2^0 \times 0) + (2^1 \times 0) + (2^2 \times 1) + (2^3 \times 1) \rightarrow \sum_{n=0}^3 (2^n \times s_n)
\]\\

\begin{tabular}{|c|c|c|c|c|}\hline
  s3&s2&s1&s0&値\\\hline
  0&0&0&0& 0\\
  0&0&0&1& 1\\
  0&0&1&0& 2\\
  0&0&1&1& 3\\
  0&1&0&0& 4\\
  0&1&0&1& 5\\
  0&1&1&0& 6\\
  0&1&1&1& 7\\
  1&0&0&0& 8\\
  1&0&0&1& 9\\
  1&0&1&0& 10\\
  1&0&1&1& 11\\
  1&1&0&0& 12\\\hline
  1&1&0&1& 13\\
  1&1&1&0& 14\\
  1&1&1&1& 15\\\hline
\end{tabular}\\

前の例で実施した、バイナリーエンコーディングなしの、通常のslack変数の場合のハミルトニアンは、
\[
  H\;=\;H_A\;+\;H_B
  =\;A_1\bigg(1-\sum_{n=1}^{12}s_n\bigg)^2 + A_2\bigg(\sum_{n=1}^{12}n s_n- \sum_{\alpha=1}^{5}c_\alpha q_\alpha\bigg)^2 - B\sum_{\alpha=1}^{5}v_\alpha q_\alpha
\]
この様にしていたが、今回はまず$A_1$のかかる項はなくなる。（slack変数の選択は1つだけではなくなるから）
そして、$A_2$のかかる項では、2進符号化($2^0 s_0 + 2^1 s_1 + 2^2 s_2 + 2^3 s_n=\sum_{n=0}^3 2^n s_n$)をしなければいけないから、
\[
  H\;=\;H_A\;+\;H_B
  =A_2\bigg(\sum_{n=0}^{3}2^n s_n- \sum_{\alpha=1}^{5}c_\alpha q_\alpha\bigg)^2 - B\sum_{\alpha=1}^{5}v_\alpha q_\alpha
\]
4ビットで2進符号化している（0、1、2、3=M）ことから$M=3$とし, 荷物の数を$N=5$として式を変形していく。

\begin{eqnarray*}
  H\;&=&\;H_A\;+\;H_B\\
  &=&A_2\bigg(\sum_{n=0}^{3}2^n s_n- \sum_{\alpha=1}^{5}c_\alpha q_\alpha\bigg)^2 - B\sum_{\alpha=1}^{5}v_\alpha q_\alpha\\
&=&\;A_2\bigg(\sum_{n=0}^{M}2^n s_n - \sum_{\alpha=1}^{N}c_\alpha q_\alpha\bigg)^2 - B\sum_{\alpha=1}^{N}v_\alpha q_\alpha\\
&=&A_2\bigg(\sum_{n=0}^{M}2^n s_n\bigg)^2 + A_2\bigg(\sum_{\alpha=1}^{N}c_\alpha q_\alpha\bigg)^2 - 2A_2\bigg(\sum_{n=0}^{M}\sum_{\alpha=1}^{N}2^n s_n c_\alpha q_\alpha\bigg) - B\sum_{\alpha=1}^{N}v_\alpha q_\alpha\\
&=&A_2\bigg(\sum_{n=0}^M2^{2n}s_n^2 + 2\sum_{n_1<n_2}2^{n_1}2^{n_2}s_{n_1}s_{n_2}\bigg) + A_2\bigg(\sum_{\alpha=1}^Nc_\alpha^2q_\alpha^2 + 2\sum_{\alpha_1<\alpha_2}c_{\alpha_1} c_{\alpha_2} q_{\alpha_1} q_{\alpha_2}\bigg)\\
&-& 2A_2\bigg(\sum_{n=0}^{M}\sum_{\alpha=1}^{N}2^n s_n c_\alpha q_\alpha\bigg) - B\sum_{\alpha=1}^{N}v_\alpha q_\alpha\\
&=&2A_2\bigg(\sum_{n_1<n_2}2^{n_1}2^{n_2}s_{n_1}s_{n_2} + \sum_{\alpha_1<\alpha_2}c_{\alpha_1} c_{\alpha_2} q_{\alpha_1} q_{\alpha_2} - \sum_{n=0}^{M}\sum_{\alpha=1}^{N}2^n s_n c_\alpha q_\alpha\bigg)\\
&+& A_2\bigg(\sum_{\alpha=1}^Nc_\alpha^2q_\alpha + \sum_{n=0}^M2^{2n}s_n\bigg) - B\sum_{\alpha=1}^{N}v_\alpha q_\alpha\\
&=&2A_2\bigg(\sum_{n_1=0}^{M-1}\sum_{n_2=n_1+1}^{M}2^{n_1}2^{n_2}s_{n_1+N}s_{n_2+N} + \sum_{\alpha=1}^{N-1}\sum_{\beta=\alpha+1}^N c_\alpha c_\beta q_\alpha q_\beta - \sum_{n=0}^M\sum_{\alpha=1}^N 2^n s_{n+N}c_\alpha q_\alpha \bigg)\\
&+& A_2\bigg(\sum_{\alpha=1}^N c_\alpha^2 q_\alpha + \sum_{n=0}^M 2^{2n}s_{n+1+N}\bigg) - B\sum_{\alpha=1}^N v_\alpha q_\alpha\\
&=&2A\bigg(\sum_{n_1=0}^{M-1}\sum_{n_2=n_1+1}^{M}2^{n_1}2^{n_2}q_{n_1+N}q_{n_2+N} + \sum_{\alpha=1}^{N-1}\sum_{\beta=\alpha+1}^N c_\alpha c_\beta q_\alpha q_\beta - \sum_{n=0}^M\sum_{\alpha=1}^N 2^n q_{n+N}c_\alpha q_\alpha \bigg)\\
&+& A\bigg(\sum_{\alpha=1}^N c_\alpha^2 q_\alpha + \sum_{n=0}^M 2^{2n}q_{n+N}\bigg) - B\sum_{\alpha=1}^N v_\alpha q_\alpha\\
\end{eqnarray*}

終わりの式の変形では、slack変数$s_0, s_1, s_2, s_3$のそれぞれが、N個の決定変数$q$の並びの後ろに、$q_{0+N}, q_{1+N}, q_{2+N}, q_{3+N}$の4個が繋がって来ることを意識して変形させているので要注意！（$A_2$は$A$とした）
\begin{eqnarray*}
s_0&\rightarrow& s_{0+N}\rightarrow q_{0+N},\\
s_1&\rightarrow& s_{1+N}\rightarrow q_{1+N},\\
s_2&\rightarrow& s_{2+N}\rightarrow q_{2+N},\\
s_3&\rightarrow& s_{3+N}\rightarrow q_{3+N}
\end{eqnarray*}
また, この並びによって, LSBの$S_0$は左側に,MSBが右に並ぶことも確認しておく必要がある.

\subsection{実装}

\lstinputlisting[caption=MODEL3,label=l3]{model3.py}

この4ビットの2進符号化によるcost3()関数は、結局のところ「15以下」のいずれの場合も許容されることになり、「15以下」のどの値でも等しくエネルギーレヴェルの低い状態に落ち着けるだろう。つまり「12に近い方がよい」という制約が必要になる。そこで、MODEL1クラスで作成したcos()関数を追加した。ただし、このcost()関数の寄与を大きくすると結局MODEL1と同じことをしている事になるので要注意。

以下の結果の出力では、選ばれた荷物の容積の総和が12を超えるものは表示していない

\begin{verbatim}
  7.7    24.2    36.4     6.1    30.3
  0.0    14.4    48.5     8.1    40.4
  0.0     0.0    34.0    12.1    60.6
  0.0     0.0     0.0     0.7    10.1
  0.0     0.0     0.0     0.0    23.6

Sorted samples by frequency and energy:
Sample: (1, 1, 1, 1, 0, 1, 1, 1, 1), Frequency: 2, Energy: -2.84
Sample: (1, 1, 0, 1, 0, 1, 1, 1, 0), Frequency: 2, Energy: -1.84
Sample: (1, 1, 0, 0, 1, 0, 0, 1, 1), Frequency: 2, Energy: -3.33
Sample: (1, 1, 1, 0, 0, 1, 0, 1, 1), Frequency: 1, Energy: -3.76
Sample: (1, 0, 1, 1, 1, 1, 1, 1, 1), Frequency: 1, Energy: -3.46
Sample: (1, 0, 1, 1, 0, 1, 1, 0, 1), Frequency: 1, Energy: -2.07
Sample: (1, 1, 0, 1, 1, 1, 0, 1, 1), Frequency: 1, Energy: -3.43

Evaluation of solutions:
[ 2] Frequency=2, Energy=-1.84,
Solution=(1, 1, 0, 1, 0, 1, 1, 1, 0)	: value=14.0, cost= 8.0
[ 3] Frequency=2, Energy=-3.33,
Solution=(1, 1, 0, 0, 1, 0, 0, 1, 1)	: value=17.0, cost=12.0
[ 6] Frequency=1, Energy=-2.07,
Solution=(1, 0, 1, 1, 0, 1, 1, 0, 1)	: value=15.0, cost=10.0

プロセスは終了コード 0 で終了しました
\end{verbatim}

\end{document}